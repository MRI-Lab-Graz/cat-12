--- a/install_cat12_standalone.sh
+++ b/install_cat12_standalone.sh
@@ -40,25 +40,6 @@ if [[ $EUID -eq 0 ]]; then
 fi
 
 print_status "Updating system packages..."
-sudo apt-get update
-
-print_status "Installing system dependencies..."
-# Install required system packages
-sudo apt-get install -y \
-    wget \
-    curl \
-    unzip \
-    build-essential \
-    python3 \
-    python3-venv \
-    libxext6 \
-    libxrender1 \
-    libxtst6 \
-    libfreetype6 \
-    libfontconfig1 \
-    libgtk2.0-0 \
-    libxss1 \
-    libgconf-2-4 \
-    libasound2
 
 # Check for CUDA installation
 print_status "Checking for CUDA installation..."
@@ -71,12 +52,7 @@ if command -v nvidia-smi &> /dev/null; then
         nvcc --version
     else
         print_warning "CUDA toolkit not found. Installing CUDA toolkit..."
-        # Install CUDA toolkit
-        wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu$(lsb_release -rs | tr -d .)/x86_64/cuda-keyring_1.0-1_all.deb
-        sudo dpkg -i cuda-keyring_1.0-1_all.deb
-        sudo apt-get update
-        sudo apt-get -y install cuda-toolkit
-        rm cuda-keyring_1.0-1_all.deb
+        print_warning "CUDA toolkit not found and cannot be installed without sudo. Please contact your system administrator if CUDA is required."
     fi
 else
     print_warning "No NVIDIA GPU detected. Proceeding with CPU-only installation."
@@ -89,20 +65,35 @@ mkdir -p "$INSTALL_DIR"
 cd "$INSTALL_DIR"
 
 # Download CAT12 standalone
-print_status "Downloading CAT12 standalone..."
-CAT12_URL="https://neuro-jena.github.io/cat12-help/cat12_latest_R2017b_MCR_Linux.zip"
+print_status "Downloading CAT12 standalone with MCR..."
+CAT12_URL="http://dbm.neuro.uni-jena.de/cat12/cat12_latest_R2023b_MCR_Linux.zip"
 wget -O cat12_standalone.zip "$CAT12_URL"
 
 print_status "Extracting CAT12 standalone..."
 unzip -q cat12_standalone.zip
 rm cat12_standalone.zip
 
-# Make executable
-chmod +x cat12_standalone/run_cat12.sh
+# Move CAT12 from nested external directory to cat12 directory
+if [ -d "external/CAT12.9_R2023b_MCR_Linux" ]; then
+    mv external/CAT12.9_R2023b_MCR_Linux cat12
+    rmdir external 2>/dev/null || rm -rf external
+fi
+
+# Make CAT12 standalone scripts executable
+if [ -d "cat12/standalone" ]; then
+    chmod +x cat12/standalone/*.sh
+fi
+chmod +x cat12/*.sh 2>/dev/null || true
 
 # Download and install MATLAB Runtime if not present
 MCR_DIR="$INSTALL_DIR/MCR"
-if [ ! -d "$MCR_DIR" ]; then
-    print_status "Downloading MATLAB Runtime R2017b..."
-    MCR_URL="https://ssd.mathworks.com/supportfiles/downloads/R2017b/deployment_files/R2017b/installers/glnxa64/MCR_R2017b_glnxa64_installer.zip"
+MCR_VERSION="v232"  # R2023b
+if [ ! -d "$MCR_DIR/$MCR_VERSION" ]; then
+    print_status "Downloading MATLAB Runtime R2023b (v232)..."
+    MCR_URL="https://ssd.mathworks.com/supportfiles/downloads/R2023b/Release/10/deployment_files/installer/complete/glnxa64/MATLAB_Runtime_R2023b_Update_10_glnxa64.zip"
     wget -O mcr_installer.zip "$MCR_URL"
     
-    print_status "Installing MATLAB Runtime..."
+    print_status "Installing MATLAB Runtime R2023b..."
     unzip -q mcr_installer.zip
-    sudo ./install -mode silent -agreeToLicense yes -destinationFolder "$MCR_DIR"
+    ./install -mode silent -agreeToLicense yes -destinationFolder "$MCR_DIR"
     rm -f mcr_installer.zip install
 else
     print_status "MATLAB Runtime already installed."
@@ -124,10 +115,12 @@ cat > .env << EOF
 # CAT12 Standalone Environment Configuration
 # Source this file to set up the environment: source .env
 
-export CAT12_ROOT="$INSTALL_DIR/cat12_standalone"
-export MCR_ROOT="$MCR_DIR/v93"
+export CAT12_ROOT="$INSTALL_DIR/cat12/standalone"
+export SPMROOT="$INSTALL_DIR/cat12"
+export MCR_ROOT="$MCR_DIR/$MCR_VERSION"
+export MCRROOT="$MCR_DIR/$MCR_VERSION"
 export LD_LIBRARY_PATH="\$MCR_ROOT/runtime/glnxa64:\$MCR_ROOT/bin/glnxa64:\$MCR_ROOT/sys/os/glnxa64:\$MCR_ROOT/sys/opengl/lib/glnxa64:\$LD_LIBRARY_PATH"
-export PATH="\$CAT12_ROOT:\$PATH"
+export PATH="\$CAT12_ROOT:\$SPMROOT:\$PATH"
 
 # Project-specific paths
 export CAT12_PROJECT_ROOT="$PROJECT_DIR"
@@ -142,18 +135,29 @@ export PATH="$HOME/.cargo/bin:$PATH"
 print_status "Creating Python virtual environment with UV..."
 uv venv .venv --python python3
 
-# Activate virtual environment
+# Activate virtual environment and install Python dependencies with UV
+print_status "Activating Python virtual environment..."
 source .venv/bin/activate
-
-# Install Python dependencies with UV
 print_status "Installing Python dependencies with UV..."
 uv pip install -r requirements.txt
 
+print_status "Fixing pybids and universal-pathlib compatibility..."
+# Force reinstall compatible versions to avoid 'Protocol not known: bids' error
+uv pip install --force-reinstall 'pybids>=0.15.1,<0.16.0' 'universal-pathlib<0.2.0'
+
 print_status "Testing CAT12 installation..."
 # Test CAT12 installation
-if [ -f "$INSTALL_DIR/cat12_standalone/run_cat12.sh" ]; then
+if [ -f "$INSTALL_DIR/cat12/standalone/cat_standalone.sh" ]; then
     print_status "CAT12 standalone installation completed successfully!"
-    print_status "CAT12 location: $INSTALL_DIR/cat12_standalone"
+    print_status "CAT12 location: $INSTALL_DIR/cat12/standalone"
     print_status "To use CAT12, run: source .env"
 else
     print_error "CAT12 installation failed!"
     exit 1
 fi
+
+print_status "Verifying pybids installation..."
+source .venv/bin/activate
+if python -c "import bids" 2>/dev/null; then
+    print_status "pybids is installed: $(python -c 'import bids; print(bids.__file__)')"
+else
+    print_warning "pybids is NOT installed in the virtual environment. Run 'pip install pybids' manually if needed."
+fi
